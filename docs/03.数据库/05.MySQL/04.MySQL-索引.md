---
title: MySQL - 索引
permalink: /mysql/index/
date: 2021-05-20 20:51:46
---

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [索引的概念](#%E7%B4%A2%E5%BC%95%E7%9A%84%E6%A6%82%E5%BF%B5)
- [Mysql 的索引](#mysql-%E7%9A%84%E7%B4%A2%E5%BC%95)
  - [推荐文章](#%E6%8E%A8%E8%8D%90%E6%96%87%E7%AB%A0)
  - [Btree索引](#btree%E7%B4%A2%E5%BC%95)
  - [B+tree索引](#btree%E7%B4%A2%E5%BC%95)
  - [聚簇索引和非聚簇索引](#%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95%E5%92%8C%E9%9D%9E%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95)
  - [时间复杂度](#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6)
- [Mysql 索引分类](#mysql-%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB)
  - [单值索引](#%E5%8D%95%E5%80%BC%E7%B4%A2%E5%BC%95)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->



## 索引的概念

索引（Index）是帮助 MySQL 高效获取数据的数据结构，可以简单理解为**排好序的快速查找数据结构**。

在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据， 这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引

![image-20210520182908854](https://cdn.jsdelivr.net/gh/oddfar/static/img/MySQL高级.assets/image-20210520182908854.png)

左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址。为了加快 Col2 的查找，可以维护一个 右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用二叉查找在一定的复杂度内获取到相应数据，从而快速的检索出符合条件的记录。

一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。



**索引优缺点**

优势：

- 提高数据检索的效率，降低数据库的IO成本。
- 数据排序，降低CPU消耗

劣势：

- 虽然索引大大提高了查询速度，同时却会降低更新表的速度

  如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因更新所带来的键值变化后的索引信息。

- 索引本质也是一张表，保存着索引字段和指向实际记录的指针，所以也要占用数据库空间，一般而言，索引表占用的空间是数据表的1.5倍



## Mysql 的索引

### 推荐文章

- [MySQL 索引原理 图文讲解](https://zhuanlan.zhihu.com/p/359306500)

  涉及到树相关数据结构知识。

- [BTree和B+Tree](https://www.jianshu.com/p/ac12d2c83708)

  详细介绍



### Btree索引

黑马教程：https://www.bilibili.com/video/BV1UQ4y1P7Xr?p=6

**Btree又可以写成B-tree**（B-Tree，并不是B“减”树，横杠为连接符，容易被误导）

MySQL 使用的是 Btree 索引。

![image-20210520190717898](https://cdn.jsdelivr.net/gh/oddfar/static/img/MySQL高级.assets/image-20210520190717898.png)

**初始化介绍**



一颗 b 树，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色 所示），

如磁盘块 1 包含数据项 17 和 35，包含指针 P1、P2、P3，
P1 表示小于 17 的磁盘块，P2 表示在 17 和 35 之间的磁盘块，P3 表示大于 35 的磁盘块。
真实的数据存在于叶子节点即 3、5、9、10、13、15、28、29、36、60、75、79、90、99。
非叶子节点只不存储真实的数据，只存储指引搜索方向的数据项，如 17、35 并不真实存在于数据表中

**查找过程**

如果要查找数据项 29，那么首先会把磁盘块 1 由磁盘加载到内存，此时发生一次 IO，在内存中用二分查找确定 29 在 17 和 35 之间，锁定磁盘块 1 的 P2 指针，内存时间因为非常短（相比磁盘的 IO）可以忽略不计，通过磁盘块 1 的 P2 指针的磁盘地址把磁盘块 3 由磁盘加载到内存，发生第二次 IO，29 在 26 和 30 之间，锁定磁盘块 3 的 P2 指 针，通过指针加载磁盘块 8 到内存，发生第三次 IO，同时内存中做二分查找找到 29，结束查询，总计三次 IO。



真实的情况是，3 层的 b+树可以表示上百万的数据，如果上百万的数据查找只需要三次 IO，性能提高将是巨大的， 如果没有索引，每个数据项都要发生一次 IO，那么总共需要百万次的 IO，显然成本非常非常高。



### B+tree索引

![1555906287178](https://cdn.jsdelivr.net/gh/oddfar/static/img/MySQL高级.assets/00001.jpg)



**B+Tree 与 B-Tree 的区别**

- B-树的关键字和记录是放在一起的，叶子节点可以看作外部节点，不包含任何信息；B+树的非叶子节点中只有关键字和指向下一个节点的索引，记录只放在叶子节点中。
- 在 B-树中，越靠近根节点的记录查找时间越快，只要找到关键字即可确定记录的存在；而 B+树中每个记录的查找时间基本是一样的，都需要从根节点走到叶子节点，而且在叶子节点中还要再比较关键字。从这个角度看 B- 树的性能好像要比 B+树好，而在实际应用中却是 B+树的性能要好些。因为 B+树的非叶子节点不存放实际的数据， 这样每个节点可容纳的元素个数比 B-树多，树高比 B-树小，这样带来的好处是减少磁盘访问次数。尽管 B+树找到 一个记录所需的比较次数要比 B-树多，但是一次磁盘访问的时间相当于成百上千次内存比较的时间，因此实际中 B+树的性能可能还会好些，而且 B+树的叶子节点使用指针连接在一起，方便顺序遍历（例如查看一个目录下的所有 文件，一个表中的所有记录等），这也是很多数据库和文件系统使用 B+树的缘故。

**为什么B+树比 B-树更适合索引？**

- B+树的磁盘读写代价更低

  B+树的内部结点并没有指向关键字具体信息的指针。因此其内部结点相对 B 树更小。如果把所有同一内部结点 的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多。一次性读入内存中的需要查找的关键字也就 越多。相对来说 IO 读写次数也就降低了。

- B+树的查询效率更加稳定

  由于非终结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须 走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。





### 聚簇索引和非聚簇索引

聚簇索引并不是一种单独的索引类型，而是一种数据存储方式。术语‘聚簇’表示数据行和相邻的键值聚簇的存储 在一起。如下图，左侧的索引就是聚簇索引，因为数据行在磁盘的排列和索引排序保持一致。



![image-20210520211641159](https://cdn.jsdelivr.net/gh/oddfar/static/img/MySQL高级.assets/image-20210520211641159.png)

**聚簇索引的好处**

按照聚簇索引排列顺序，查询显示一定范围数据的时候，由于数据都是紧密相连，数据库不不用从多 个数据块中提取数据，所以节省了大量的 io 操作。

**聚簇索引的限制**

对于 mysql 数据库目前只有 innodb 数据引擎支持聚簇索引，而 Myisam 并不支持聚簇索引。

由于数据物理存储排序方式只能有一种，所以每个 Mysql 的表只能有一个聚簇索引。一般情况下就是该表的主键。

为了充分利用聚簇索引的聚簇的特性，所以 innodb 表的主键列尽量选用有序的顺序 id，而不建议用无序的 id，比如 uuid 这种。

### 时间复杂度

同一问题可用不同算法解决，而一个算法的质量优劣将影响到算法乃至程序的效率。算法分析的目的在于选择合适算法和改进算法。

时间复杂度是指执行算法所需要的计算工作量，用大 O 表示记为：O(…)

![image-20210520211835491](https://cdn.jsdelivr.net/gh/oddfar/static/img/MySQL高级.assets/image-20210520211835491.png)

![image-20210520212305695](https://cdn.jsdelivr.net/gh/oddfar/static/img/MySQL高级.assets/image-20210520212305695.png)

## Mysql 索引分类

### 单值索引

概念：即一个索引只包含单个列，一个表可以有多个单列索引

